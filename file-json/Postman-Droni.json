{
  "info": {
    "_postman_id": "mock-api-forest-v3",
    "name": "Mock API + On-Chain - Device & Flight Data",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "Init Device On-Chain",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "{{AUTH_TOKEN}}", "type": "text" },
          { "key": "Content-Type", "value": "application/json", "type": "text" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{}"
        },
        "url": { "raw": "{{API_URL}}/init-device-onchain", "host": ["{{API_URL}}", "init-device-onchain"] },
        "description": "Crea o recupera device, dataset, flight data, salva batch JSON e registra tutto on-chain"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    var json = pm.response.json();",
              "    pm.globals.set('deviceId', json.deviceId);",
              "    json.datasets.forEach((ds, idx) => {",
              "        pm.globals.set('datasetId_' + idx, ds.datasetId);",
              "        pm.globals.set('merkleRoot_' + idx, ds.merkleRoot);",
              "        pm.globals.set('txHash_' + idx, ds.txHash);",
              "    });",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Create Device (solo API REST)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "{{AUTH_TOKEN}}", "type": "text" },
          { "key": "Content-Type", "value": "application/json", "type": "text" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"pk\": \"{{devicePk}}\" }"
        },
        "url": { "raw": "{{API_URL}}/device", "host": ["{{API_URL}}", "device"] },
        "description": "Crea un nuovo device (senza registrazione on-chain)"
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    var json = pm.response.json();",
              "    pm.globals.set('deviceId', json.id);",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ]
    },
    {
      "name": "Get Device",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "{{AUTH_TOKEN}}", "type": "text" },
          { "key": "Content-Type", "value": "application/json", "type": "text" }
        ],
        "body": { "mode": "raw", "raw": "{ \"deviceId\": \"{{deviceId}}\" }" },
        "url": { "raw": "{{API_URL}}/device/get", "host": ["{{API_URL}}", "device", "get"] },
        "description": "Recupera i dettagli di un device"
      }
    },
    {
      "name": "Create Dataset",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "{{AUTH_TOKEN}}", "type": "text" },
          { "key": "Content-Type", "value": "application/json", "type": "text" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"device_id\": \"{{deviceId}}\", \"name\": \"{{datasetName}}\", \"description\": \"{{datasetDescription}}\" }"
        },
        "url": { "raw": "{{API_URL}}/dataset", "host": ["{{API_URL}}", "dataset"] },
        "description": "Crea un nuovo dataset per un device"
      }
    },
    {
      "name": "Add Flight Data",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "{{AUTH_TOKEN}}", "type": "text" },
          { "key": "Content-Type", "value": "application/json", "type": "text" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"device_id\": \"{{deviceId}}\", \"dataset_id\": \"{{datasetId}}\", \"timestamp\": {{timestamp}}, \"localization\": { \"latitude\": {{latitude}}, \"longitude\": {{longitude}} }, \"payload\": \"{{payload}}\" }"
        },
        "url": { "raw": "{{API_URL}}/flight_data", "host": ["{{API_URL}}", "flight_data"] },
        "description": "Aggiunge un flight data a un dataset"
      }
    },
    {
      "name": "Get Flight Data for Dataset",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "{{AUTH_TOKEN}}", "type": "text" },
          { "key": "Content-Type", "value": "application/json", "type": "text" }
        ],
        "body": { "mode": "raw", "raw": "{ \"dataset_id\": \"{{datasetId}}\" }" },
        "url": { "raw": "{{API_URL}}/dataset/flight_datas", "host": ["{{API_URL}}", "dataset", "flight_datas"] },
        "description": "Recupera tutti i flight data per un dataset"
      }
    },
    {
      "name": "Register Dataset On-Chain (simulazione endpoint)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "{{AUTH_TOKEN}}", "type": "text" },
          { "key": "Content-Type", "value": "application/json", "type": "text" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{ \"deviceId\": \"{{deviceId}}\", \"datasetId\": \"{{datasetId}}\", \"merkleRoot\": \"{{merkleRoot_0}}\" }"
        },
        "url": { "raw": "{{API_URL}}/register-onchain", "host": ["{{API_URL}}", "register-onchain"] },
        "description": "Endpoint simulato per registrazione on-chain del dataset e device"
      }
    }
  ]
}
